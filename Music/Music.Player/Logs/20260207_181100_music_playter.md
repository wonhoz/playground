╭──────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Plan to implement                                                                                    │
│                                                                                                      │
│ Music.Player - Drag & Drop 버그 수정 및 개선 계획                                                    │
│                                                                                                      │
│ Context                                                                                              │
│                                                                                                      │
│ Music.Player 프로젝트의 드래그 앤 드롭으로 파일 추가 시 발생할 수 있는 버그와 개선점을 분석하여      │
│ 수정한다.                                                                                            │
│                                                                                                      │
│ 발견된 문제                                                                                          │
│                                                                                                      │
│ Bug 1: 파일 경로 중복 검사가 대소문자를 구분함 (HIGH)                                                │
│                                                                                                      │
│ - 파일: MainWindow.xaml.cs:497                                                                       │
│ - 코드: _playlist.Any(t => t.FilePath == filePath)                                                   │
│ - 문제: Windows에서 C:\Music\Song.mp3와 c:\music\song.mp3는 같은 파일이지만, 현재 == 비교는          │
│ case-sensitive라서 중복 추가가 가능함                                                                │
│ - 수정: StringComparison.OrdinalIgnoreCase와 Path.GetFullPath()를 사용하여 경로 정규화 후 비교       │
│                                                                                                      │
│ Bug 2: PlaylistBox_Drop에서 e.Handled 미설정 (MEDIUM)                                                │
│                                                                                                      │
│ - 파일: MainWindow.xaml.cs:593-600                                                                   │
│ - 문제: PlaylistBox_Drop에서 e.Handled = true를 설정하지 않아, 드롭 이벤트가 부모인 MainWindow까지   │
│ 버블링됨. 결과적으로 AddFiles()가 두 번 호출됨 (중복은 방지되지만 불필요한 이중 처리 및 플레이리스트 │
│  패널 토글 로직이 중복 실행됨)                                                                       │
│ - 수정: e.Handled = true 추가                                                                        │
│                                                                                                      │
│ Bug 3: Drop 핸들러에 null 안전성 부재 (LOW)                                                          │
│                                                                                                      │
│ - 파일: MainWindow.xaml.cs:568, 597, 688                                                             │
│ - 문제: e.Data.GetData(DataFormats.FileDrop)의 결과를 null 체크 없이 바로 캐스팅. 예외 발생 시       │
│ 드래그 앤 드롭이 한 번 실패하면 이후에도 계속 실패할 수 있는 상황은 아니지만, 방어적 코딩이 필요     │
│ - 수정: as string[] 패턴으로 null-safe 캐스팅                                                        │
│                                                                                                      │
│ Bug 4: LoadFilesFromArgs에서 경로 정규화/중복 검사 누락 (LOW)                                        │
│                                                                                                      │
│ - 파일: MainWindow.xaml.cs:815-847                                                                   │
│ - 문제: LoadFilesFromArgs는 AddTrack 대신 직접 _playlist.Add를 호출하므로 중복 검사를 우회함         │
│ - 수정: AddTrack 메서드를 재사용하도록 변경                                                          │
│                                                                                                      │
│ 수정 계획                                                                                            │
│                                                                                                      │
│ Step 1: AddTrack 메서드에 경로 정규화 및 대소문자 무시 비교 추가                                     │
│                                                                                                      │
│ 파일: MainWindow.xaml.cs:495-501                                                                     │
│ private void AddTrack(string filePath)                                                               │
│ {                                                                                                    │
│     var fullPath = System.IO.Path.GetFullPath(filePath);                                             │
│     if (_playlist.Any(t => string.Equals(t.FilePath, fullPath, StringComparison.OrdinalIgnoreCase))) │
│  return;                                                                                             │
│                                                                                                      │
│     var track = TrackInfo.FromFile(fullPath);                                                        │
│     _playlist.Add(track);                                                                            │
│ }                                                                                                    │
│                                                                                                      │
│ Step 2: PlaylistBox_Drop에 e.Handled = true 추가                                                     │
│                                                                                                      │
│ 파일: MainWindow.xaml.cs:593-600                                                                     │
│                                                                                                      │
│ Step 3: 모든 Drop 핸들러에 null-safe 캐스팅 적용                                                     │
│                                                                                                      │
│ 파일: MainWindow.xaml.cs - MainWindow_Drop, PlaylistBox_Drop, PlaylistItem_Drop 3곳                  │
│                                                                                                      │
│ Step 4: LoadFilesFromArgs에서 AddTrack 재사용                                                        │
│                                                                                                      │
│ 파일: MainWindow.xaml.cs:815-847 - 직접 _playlist.Add 대신 AddTrack 호출                             │
│                                                                                                      │
│ 수정 대상 파일                                                                                       │
│                                                                                                      │
│ - MainWindow.xaml.cs (1개 파일만 수정)                                                               │
│                                                                                                      │
│ 검증                                                                                                 │
│                                                                                                      │
│ - 빌드 성공 확인 (dotnet build)                                                                      │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────╯









수정 완료 요약

MainWindow.xaml.cs 1개 파일에 4가지 버그를 수정했습니다. 빌드 성공 확인 완료.
┌────────────┬────────────────────────────────────────────────────────────────────────┬──────────────┐
│    Bug     │                               수정 내용                                │     위치     │
├────────────┼────────────────────────────────────────────────────────────────────────┼──────────────┤
│ Bug 1      │ AddTrack에 Path.GetFullPath() 경로 정규화 +                            │ Line 495-502 │
│ (HIGH)     │ StringComparison.OrdinalIgnoreCase 대소문자 무시 비교 적용             │              │
├────────────┼────────────────────────────────────────────────────────────────────────┼──────────────┤
│ Bug 2      │ PlaylistBox_Drop에 e.Handled = true 추가하여 이벤트 버블링 방지        │ Line 603     │
│ (MEDIUM)   │                                                                        │              │
├────────────┼────────────────────────────────────────────────────────────────────────┼──────────────┤
│ Bug 3      │ 3개 Drop 핸들러(MainWindow_Drop, PlaylistBox_Drop, PlaylistItem_Drop)  │ Line 569,    │
│ (LOW)      │ 모두 as string[] null-safe 캐스팅으로 변경                             │ 599, 692     │
├────────────┼────────────────────────────────────────────────────────────────────────┼──────────────┤
│ Bug 4      │ LoadFilesFromArgs에서 _playlist.Add 직접 호출 대신 AddTrack 재사용으로 │ Line 836     │
│ (LOW)      │  중복 검사 통합                                                        │              │
└────────────┴────────────────────────────────────────────────────────────────────────┴──────────────┘