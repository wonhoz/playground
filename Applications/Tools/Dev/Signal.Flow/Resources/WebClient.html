<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Signal.Flow â€” ë¸Œë¼ìš°ì € í´ë¼ì´ì–¸íŠ¸</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.7/signalr.min.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Segoe UI', sans-serif;
    background: #0D0D16;
    color: #E0E0F0;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  header {
    background: #131321;
    border-bottom: 1px solid #2A2A3D;
    padding: 10px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
  }
  header h1 { font-size: 15px; font-weight: 700; color: #06B6D4; }
  header span { font-size: 12px; color: #888898; }
  .columns {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1px;
    flex: 1;
    overflow: hidden;
    background: #2A2A3D;
  }
  .col {
    background: #0D0D16;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .col-header {
    background: #131321;
    border-bottom: 1px solid #2A2A3D;
    padding: 8px 14px;
    display: flex;
    align-items: center;
    gap: 10px;
    flex-shrink: 0;
  }
  .col-title { font-size: 13px; font-weight: 600; color: #E0E0F0; }
  .status-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: #EF4444;
    transition: background 0.3s;
    flex-shrink: 0;
  }
  .status-dot.connected { background: #22C55E; }
  .status-dot.reconnecting { background: #F59E0B; animation: pulse 1s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
  .status-text { font-size: 11px; color: #888898; }
  .count-badge {
    margin-left: auto;
    background: #1A1A2E;
    border: 1px solid #2A2A3D;
    border-radius: 10px;
    padding: 1px 8px;
    font-size: 11px;
    color: #888898;
  }
  .log-area {
    flex: 1;
    overflow-y: auto;
    padding: 6px 0;
  }
  .log-area::-webkit-scrollbar { width: 6px; }
  .log-area::-webkit-scrollbar-track { background: transparent; }
  .log-area::-webkit-scrollbar-thumb { background: #3A3A55; border-radius: 3px; }
  .log-area::-webkit-scrollbar-thumb:hover { background: #06B6D4; }
  .event-row {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 5px 14px;
    border-bottom: 1px solid #131321;
    font-size: 12px;
    animation: fadeIn 0.2s;
  }
  @keyframes fadeIn { from{opacity:0;transform:translateY(-4px)} to{opacity:1;transform:none} }
  .badge {
    flex-shrink: 0;
    font-size: 10px;
    font-weight: 700;
    border-radius: 4px;
    padding: 1px 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .badge-notify  { background: #0E7490; color: #A5F3FC; }
  .badge-update  { background: #065F46; color: #6EE7B7; }
  .badge-warning { background: #92400E; color: #FDE68A; }
  .badge-error   { background: #7F1D1D; color: #FCA5A5; }
  .badge-system  { background: #1E1B4B; color: #C4B5FD; }
  .time { color: #555570; flex-shrink: 0; font-size: 11px; }
  .msg  { color: #C0C0D0; flex: 1; }
  .src  { color: #555570; font-size: 10px; flex-shrink: 0; }
  .empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    gap: 8px;
    color: #444460;
    font-size: 13px;
  }
  .empty-icon { font-size: 32px; opacity: 0.5; }
</style>
</head>
<body>

<header>
  <h1>Signal.Flow</h1>
  <span>ì„œë²„ í‘¸ì‹œ ê¸°ìˆ  ë¹„êµ â€” ë¸Œë¼ìš°ì € í´ë¼ì´ì–¸íŠ¸</span>
</header>

<div class="columns">
  <!-- SignalR ì»¬ëŸ¼ -->
  <div class="col">
    <div class="col-header">
      <div id="srDot" class="status-dot"></div>
      <span class="col-title">SignalR</span>
      <span id="srStatus" class="status-text">ì—°ê²° ì¤‘...</span>
      <span id="srCount" class="count-badge">0</span>
    </div>
    <div class="log-area" id="srLog">
      <div class="empty" id="srEmpty">
        <div class="empty-icon">ğŸ“¡</div>
        <div>ì´ë²¤íŠ¸ ëŒ€ê¸° ì¤‘</div>
      </div>
    </div>
  </div>

  <!-- SSE ì»¬ëŸ¼ -->
  <div class="col">
    <div class="col-header">
      <div id="sseDot" class="status-dot"></div>
      <span class="col-title">SSE (EventSource)</span>
      <span id="sseStatus" class="status-text">ì—°ê²° ì¤‘...</span>
      <span id="sseCount" class="count-badge">0</span>
    </div>
    <div class="log-area" id="sseLog">
      <div class="empty" id="sseEmpty">
        <div class="empty-icon">ğŸŒŠ</div>
        <div>ì´ë²¤íŠ¸ ëŒ€ê¸° ì¤‘</div>
      </div>
    </div>
  </div>
</div>

<script>
const host = location.host;

// â”€â”€ ê³µí†µ ìœ í‹¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtTime(ts) {
  const d = new Date(ts);
  return d.toLocaleTimeString('ko-KR', { hour12: false,
    hour: '2-digit', minute: '2-digit', second: '2-digit' }) +
    '.' + String(d.getMilliseconds()).padStart(3, '0');
}

function badgeClass(type) {
  const map = { notify:'notify', update:'update', warning:'warning', error:'error' };
  return 'badge-' + (map[type] || 'system');
}

function appendEvent(logEl, emptyEl, countEl, evt) {
  const empty = logEl.querySelector('.empty');
  if (empty) empty.remove();

  const row = document.createElement('div');
  row.className = 'event-row';
  const type = evt.type || evt.Type || 'system';
  const msg  = evt.message || evt.Message || '';
  const src  = evt.source  || evt.Source  || '';
  const ts   = evt.timestamp || evt.Timestamp || new Date().toISOString();

  row.innerHTML = `
    <span class="badge ${badgeClass(type)}">${type}</span>
    <span class="time">${fmtTime(ts)}</span>
    <span class="msg">${escHtml(msg)}</span>
    <span class="src">${escHtml(src)}</span>`;
  logEl.insertBefore(row, logEl.firstChild);

  const n = parseInt(countEl.textContent) + 1;
  countEl.textContent = n;
}

function escHtml(s) {
  return String(s)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;');
}

function setStatus(dot, statusEl, cls, text) {
  dot.className = 'status-dot' + (cls ? ' ' + cls : '');
  statusEl.textContent = text;
}

// â”€â”€ SignalR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const srDot    = document.getElementById('srDot');
const srStatus = document.getElementById('srStatus');
const srLog    = document.getElementById('srLog');
const srCount  = document.getElementById('srCount');

const conn = new signalR.HubConnectionBuilder()
  .withUrl(`http://${host}/hub`)
  .withAutomaticReconnect()
  .build();

conn.on('Event', evt => {
  appendEvent(srLog, null, srCount, evt);
});

conn.onreconnecting(() => setStatus(srDot, srStatus, 'reconnecting', 'ì¬ì—°ê²° ì¤‘'));
conn.onreconnected(()  => setStatus(srDot, srStatus, 'connected',   'ì—°ê²°ë¨'));
conn.onclose(()        => setStatus(srDot, srStatus, '',            'ëŠê¹€'));

(async () => {
  try {
    await conn.start();
    setStatus(srDot, srStatus, 'connected', 'ì—°ê²°ë¨');
  } catch(e) {
    setStatus(srDot, srStatus, '', 'ì—°ê²° ì‹¤íŒ¨');
  }
})();

// â”€â”€ SSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const sseDot    = document.getElementById('sseDot');
const sseStatus = document.getElementById('sseStatus');
const sseLog    = document.getElementById('sseLog');
const sseCount  = document.getElementById('sseCount');

function connectSse() {
  const es = new EventSource(`http://${host}/sse`);

  es.onopen = () => setStatus(sseDot, sseStatus, 'connected', 'ì—°ê²°ë¨');
  es.onerror = () => {
    setStatus(sseDot, sseStatus, '', 'ì¬ì—°ê²° ì¤‘');
    es.close();
    setTimeout(connectSse, 3000);
  };
  es.onmessage = e => {
    try {
      const evt = JSON.parse(e.data);
      if (evt.connected) return;
      appendEvent(sseLog, null, sseCount, evt);
    } catch {}
  };
}
connectSse();
</script>
</body>
</html>
