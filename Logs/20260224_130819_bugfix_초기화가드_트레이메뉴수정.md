# 버그픽스: 초기화 가드 + 트레이 메뉴 짜부러짐 수정

- **날짜**: 2026-02-24 (KST)
- **브랜치**: `fix/init-guard-tray-menu`
- **태그**: `bugfix`

---

## 작업 개요

실행 시 발생하는 버그 2종 수정 및 재발 방지 지침 추가:
1. **NullReferenceException** - WPF 이벤트 핸들러가 `InitializeComponent()` 도중 발동되어 미초기화 필드 접근
2. **ContextMenuStrip 짜부러짐** - Toast.Cast 트레이 메뉴 이모지 아이템 폭 계산 오류

---

## 수정 파일

### 1. Env.Guard - `MainWindow.xaml.cs`
- **원인**: XAML `<RadioButton IsChecked="True" Checked="ScopeFilter_Changed"/>` → `InitializeComponent()` 도중 `ScopeFilter_Changed` 이벤트 발동 → `TxtSearch` 아직 null
- **수정**: `ApplyFilter()` 첫 줄에 `if (!IsLoaded) return;` 추가

### 2. Link.Vault - `MainWindow.xaml.cs`
- **원인**: XAML 초기화 도중 이벤트 발동 → `_db` 아직 null
- **수정**: `Refresh()` 첫 줄에 `if (!IsLoaded || _db == null) return;` 추가

### 3. Log.Lens - `MainWindow.xaml.cs`
- **원인**: XAML 초기화 도중 탭 선택 이벤트 발동 → 미초기화 필드 접근
- **수정**: `ApplyFilter()` 첫 줄에 `if (!IsLoaded) return;` 추가

### 4. Toast.Cast - `TrayApp.cs`
- **원인**: `ContextMenuStrip`에 `ShowImageMargin`, `AutoSize`, `Font` 미설정 → 이모지 아이템 폭 계산 오류로 짜부러짐
- **수정**: `_menu` 생성 시 `AutoSize = true`, `ShowImageMargin = false`, `Font = new Font("Segoe UI", 9.5f)` 추가

### 5. CLAUDE.md
- **트레이 메뉴 규칙** (`⚠️ ContextMenuStrip 폭 짜부러짐 방지`) 추가
- **이벤트 핸들러 초기화 가드 규칙** (`⚠️ 이벤트 핸들러 초기화 안전 가드`) 추가

---

## 빌드 결과

| 프로젝트 | 경고 | 오류 |
|---------|------|------|
| Env.Guard | 0 | 0 |
| Link.Vault | 0 | 0 |
| Log.Lens | 0 | 0 |
| Toast.Cast | 0 | 0 |
